<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Alien Slayer</title>
	<style>
		body {
			margin: 0;
			padding: 0;
			background-color: #000000;
		}
	</style>
	
	<script type="text/javascript" src="js/pixi.js" /></script>
	
	<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDOcpCtOlY1V3mqzDkeMNY2F99eFO6CTr0&callback=setup"></script>
	
	<script type="text/javascript"> 

		//var MAP_CENTER = {lat:50.452703, lon:30.613690};	// киев
		var MAP_CENTER = {lat:36.136817, lon:-86.7350286};	// нэшвилл
		var STAGE_W = 800;
		var STAGE_H = 500;
		var STAGE_BORDER = 50;
		var map;
		var renderer;
		var stage;
		var bunny;
		var MOVE_STEP = 5;

		window.onload = function()
		{
			//setup();
		}
		
		function setup() {
			
			var mapDiv = document.getElementById('mapDiv');

			map = new google.maps.Map(mapDiv, {
				center: { lat: MAP_CENTER.lat, lng: MAP_CENTER.lon },
				zoom: 18,
				tilt: 45,
				disableDefaultUI: true,
				keyboardShortcuts: false,
				mapTypeId: google.maps.MapTypeId.SATELLITE				// HYBRID, ROADMAP, SATELLITE, TERRAIN
			});
			
			stage = new PIXI.Stage();
			
			// create a renderer instance.
			renderer = PIXI.autoDetectRenderer(STAGE_W, STAGE_H, {transparent: true});	//console.log(renderer.height);
			
			// add the renderer view element to the DOM
			document.body.appendChild(renderer.view);
			
			renderer.view.style.position = "absolute";
			renderer.view.style.top = "0px";
			renderer.view.style.left = "0px";

			// create a texture from an image path
			var texture = PIXI.Texture.fromImage("res/bunny.png");

			bunny = new PIXI.Sprite(texture);

			// center the sprites anchor point
			bunny.anchor.x = 0.5;
			bunny.anchor.y = 0.5;
			
			bunny.x = 50;
			bunny.y = 50;
			
			stage.addChild(bunny);

			gameLoop();
		}

		function gameLoop() {
		
			requestAnimationFrame(gameLoop);

			bunny.rotation += 0.1;

			// render the container
			renderer.render(stage);
			
			onKeyMove();
		}
		
		function keyboard(keyCode) {
			var key = {};
			key.code = keyCode;
			key.isDown = false;
			key.isUp = true;
			key.press = undefined;
			key.release = undefined;
			key.downHandler = function(event) {
				if (event.keyCode === key.code) {
					//if (key.isUp && key.press) key.press();
					key.isDown = true;
					key.isUp = false;
				}
				event.preventDefault();
			};
			key.upHandler = function(event) {
				if (event.keyCode === key.code) {
					//if (key.isDown && key.release) key.release();
					key.isDown = false;
					key.isUp = true;
				}
				event.preventDefault();
			};

			window.addEventListener( "keydown", key.downHandler.bind(key), false );
			window.addEventListener( "keyup", key.upHandler.bind(key), false );

			return key;
		}
		
		var left = keyboard(37),
			up = keyboard(38),
			right = keyboard(39),
			down = keyboard(40);
		
		function onKeyMove() {
			if( left.isDown ) {
				bunny.x -= MOVE_STEP;
			}
			if( up.isDown ) {
				bunny.y -= MOVE_STEP;
			}
			if( right.isDown ) {
				bunny.x += MOVE_STEP;
			}
			if( down.isDown ) {
				bunny.y += MOVE_STEP;
			}
			
			var pan = contain( bunny, {x:STAGE_BORDER, y:STAGE_BORDER, w:STAGE_W-STAGE_BORDER, h:STAGE_H-STAGE_BORDER} );
			
			if( pan ) {
				map.panBy(pan.x, pan.y);
			}
		}
		
		function contain(sprite, cont) {

			var x = 0,
				y = 0;

			//Left
			if (sprite.x < cont.x) {
				sprite.x = cont.x;
				x = -MOVE_STEP;
			}

			//Top
			if (sprite.y < cont.y) {
				sprite.y = cont.y;
				y = -MOVE_STEP;
			}

			//Right
			if (sprite.x + sprite.width > cont.w) {
				sprite.x = cont.w - sprite.width;
				x = MOVE_STEP;
			}

			//Bottom
			if (sprite.y + sprite.height > cont.h) {
				sprite.y = cont.h - sprite.height;
				y = MOVE_STEP;
			}
			
			return ( x || y ) ? {x:x, y:y} : undefined;
		}

	</script>
	
</head>

<body>

	<div id="mapDiv" style='position:relative; width:800px; height:500px;'></div>

</body>

</html>